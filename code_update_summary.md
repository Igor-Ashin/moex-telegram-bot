# Актуализация кода - Обновление функции calculate_single_delta

## Обзор изменений

Функция `calculate_single_delta` была обновлена в соответствии с последними изменениями в `main.py`. Актуализированы также связанные модули для обеспечения полной совместимости.

## Основные изменения

### 1. Обновлена функция `calculate_money_ad` в `analysis/indicators.py`

**Старая версия (простой A/D Line):**
```python
def calculate_money_ad(df: pd.DataFrame) -> pd.Series:
    mf_multiplier = ((df['close'] - df['low']) - (df['high'] - df['close'])) / (df['high'] - df['low'])
    mf_volume = mf_multiplier * df['volume']
    ad_line = mf_volume.cumsum()
    return ad_line
```

**Новая версия (Chaikin A/D Line):**
```python
def calculate_money_ad(df: pd.DataFrame) -> pd.DataFrame:
    df = df.copy()
    df['TYP'] = (df['high'] + df['low'] + df['close']) / 3
    df['CLV'] = ((df['close'] - df['low']) - (df['high'] - df['close'])) / (df['high'] - df['low'])
    df['CLV'] = df['CLV'].fillna(0)
    df['money_flow'] = df['CLV'] * df['volume'] * df['TYP']
    df['money_ad'] = df['money_flow'].cumsum()
    return df
```

**Ключевые отличия:**
- Добавлен расчет TYP (Typical Price)
- Использование CLV с объемом и типичной ценой
- Возвращается DataFrame вместо Series

### 2. Создан новый модуль `bot/services/delta_analysis.py`

Включает полную актуализированную версию функции `calculate_single_delta` со всеми возможностями:

**Основные функции:**
- `calculate_single_delta()` - главная функция анализа дельты
- `DeltaAnalyzer.calculate_delta_metrics()` - расчет метрик без UI
- `DeltaAnalyzer.scan_delta_opportunities()` - поиск торговых возможностей

**Новые возможности анализа:**
- EMA20/EMA50 дневные сигналы (лонг/шорт)
- SMA30 недельный анализ
- Фильтрация по среднедневному обороту (50 млн ₽)
- Расчет отношения дельты к обороту
- Коэффициент превышения объема
- Детальное форматирование результатов

### 3. Обновлены клиенты данных

**В `data/moex_client.py`:**
- Обновлена функция `get_weekly_data()` для соответствия логике из `main.py`

**В `data/optimized_moex_client.py`:**
- Добавлена функция `get_weekly_data()` с кэшированием
- TTL кэша 1 час для недельных данных

### 4. Добавлена новая команда `/delta_scan`

**В `bot/handlers/optimized_commands.py`:**
- Новая команда для быстрого сканирования дельта-сигналов
- Анализ 22 популярных акций за 10 дней
- Поиск акций с притоком денег + лонг EMA + цена выше SMA30 weekly

### 5. Обновлен `main_refactored.py`

- Добавлены импорты новых модулей
- Зарегистрированы новые команды
- Используется оптимизированная версия `/start`

## Новые команды бота

| Команда | Описание |
|---------|----------|
| `/delta_scan` | Быстрое сканирование дельта-сигналов по 22 акциям |
| `/cache_stats` | Статистика кэша и производительности |
| `/warm_cache` | Предварительный прогрев кэша |
| `/clear_cache` | Очистка кэша |

## Технические улучшения

### 1. Производительность
- Использование оптимизированного MOEX клиента с кэшированием
- Сессия с пулом соединений
- Мониторинг производительности с декораторами

### 2. Надежность
- Обработка ошибок с использованием `@telegram_handler`
- Логирование всех операций
- Fallback для недельных данных

### 3. UX улучшения
- Индикатор набора текста `@typing_action`
- Прогресс-сообщения для длительных операций
- Форматированные таблицы результатов

## Структура модулей после обновления

```
bot/
├── services/
│   └── delta_analysis.py        # ✅ НОВЫЙ - анализ дельты денежного потока
├── handlers/
│   ├── basic.py                 # ✅ Базовые команды
│   └── optimized_commands.py    # ✅ ОБНОВЛЕН - добавлена /delta_scan
└── utils/
    └── decorators.py            # ✅ Декораторы для производительности

analysis/
└── indicators.py                # ✅ ОБНОВЛЕН - новый алгоритм Money A/D

data/
├── moex_client.py              # ✅ ОБНОВЛЕН - недельные данные
└── optimized_moex_client.py    # ✅ ОБНОВЛЕН - кэширование недельных данных

config/
├── settings.py                 # ✅ Настройки приложения
└── sectors.py                  # ✅ Тикеры и секторы

main_refactored.py              # ✅ ОБНОВЛЕН - новые команды
```

## Совместимость

✅ **Полная совместимость** с оригинальной функцией `calculate_single_delta` из `main.py`
✅ **Улучшенная производительность** за счет кэширования
✅ **Расширенная функциональность** с новыми командами
✅ **Модульная архитектура** для легкого сопровождения

## Следующие шаги

1. Протестировать обновленную функцию `calculate_single_delta`
2. Проверить корректность расчетов Money A/D
3. Использовать новую команду `/delta_scan` для поиска торговых возможностей
4. Мониторить производительность через `/cache_stats`

---

**Дата обновления:** $(date)
**Статус:** ✅ Готово к использованию
**Версия:** 2.1 (с актуализированной дельта-функцией)