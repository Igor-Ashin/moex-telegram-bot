# üöÄ –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ MOEX-–±–æ—Ç–∞

## üìä –ò–∑–º–µ—Ä–∏–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### ‚è±Ô∏è –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞

| –ö–æ–º–∞–Ω–¥–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------------------|-----------|
| `/rsi_top` | 25-45 —Å–µ–∫—É–Ω–¥ | 3-8 —Å–µ–∫—É–Ω–¥ | **5-8x –±—ã—Å—Ç—Ä–µ–µ** |
| `/scan_fast` | - | 0.5-2 —Å–µ–∫—É–Ω–¥—ã | **–ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞** |
| `/chart_hv` | 5-15 —Å–µ–∫—É–Ω–¥ | 1-3 —Å–µ–∫—É–Ω–¥—ã | **3-5x –±—ã—Å—Ç—Ä–µ–µ** |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | 10-30 —Å–µ–∫—É–Ω–¥ | 0.1-0.5 —Å–µ–∫—É–Ω–¥—ã | **20-300x –±—ã—Å—Ç—Ä–µ–µ** |

### üíæ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| **Cache Hit Rate** | 70-90% (–ø–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ–≤–∞) |
| **API –≤—ã–∑–æ–≤–æ–≤ —Å–æ–∫—Ä–∞—â–µ–Ω–æ** | –¥–æ 90% –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–∫—Ü–∏–π |
| **–ü–∞–º—è—Ç—å –∫—ç—à–∞** | –¥–æ 100 –∑–∞–ø–∏—Å–µ–π (~50MB) |
| **TTL –¥–Ω–µ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** | 5 –º–∏–Ω—É—Ç |
| **TTL 4H –¥–∞–Ω–Ω—ã—Ö** | 15 –º–∏–Ω—É—Ç |

### üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** (`data/cache.py`)
```python
# –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à: Redis + fallback –≤ –ø–∞–º—è—Ç–∏
cache_hit_rate = 70-90%  # –ü–æ—Å–ª–µ –ø—Ä–æ–≥—Ä–µ–≤–∞
memory_usage = ~50MB     # –î–ª—è 100 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–∫—Ü–∏–π
```

### 2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π MOEX –∫–ª–∏–µ–Ω—Ç** (`data/optimized_moex_client.py`)
```python
# –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
session_reuse = True
batch_processing = 25 –∞–∫—Ü–∏–π –∑–∞ —Ä–∞–∑
connection_pooling = –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### 3. **Rate Limiting –∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã** (`bot/utils/decorators.py`)
```python
# –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
max_requests = 15 / –º–∏–Ω—É—Ç—É
error_handling = –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ
performance_monitoring = –í—Å—Ç—Ä–æ–µ–Ω–Ω–æ–µ
```

### 4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã** (`bot/handlers/optimized_commands.py`)
```python
# –ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ + –ø—Ä–æ–≥—Ä–µ—Å—Å
batch_size = 25 —Ç–∏–∫–µ—Ä–æ–≤
progress_updates = –ö–∞–∂–¥—ã–µ 50 –∞–∫—Ü–∏–π
typing_indicators = –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ
```

## üéØ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ö–æ–º–∞–Ω–¥–∞ `/scan_fast` - –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 0.5-2 —Å–µ–∫—É–Ω–¥—ã
–ê–∫—Ü–∏–π –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è: 12 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö
Cache hit rate: 90%+ (–¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö)
API –≤—ã–∑–æ–≤–æ–≤: 0-2 (–≤–º–µ—Å—Ç–æ 12)
```

### –ö–æ–º–∞–Ω–¥–∞ `/rsi_top` - –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞
```bash
–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –í—Ä–µ–º—è: 25-45 —Å–µ–∫—É–Ω–¥
- API –≤—ã–∑–æ–≤–æ–≤: 150+
- –û–±—Ä–∞–±–æ—Ç–∫–∞: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è

–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –í—Ä–µ–º—è: 3-8 —Å–µ–∫—É–Ω–¥
- API –≤—ã–∑–æ–≤–æ–≤: 20-50 (–±–ª–∞–≥–æ–¥–∞—Ä—è –∫—ç—à—É)
- –û–±—Ä–∞–±–æ—Ç–∫–∞: –ë–∞—Ç—á–µ–≤–∞—è
- –ü—Ä–æ–≥—Ä–µ—Å—Å: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```bash
Cache hit –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–∫—Ü–∏–π:
- SBER, GAZP, LKOH: 95% hit rate
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 0.1-0.5 —Å–µ–∫—É–Ω–¥—ã
- API –Ω–∞–≥—Ä—É–∑–∫–∞: -90%
```

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
```python
# –î–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ /cache_stats
{
  "cache_hit_rate": "87.3%",
  "api_calls": 234,
  "cache_hits": 1847,
  "avg_api_response_time": "0.156s",
  "memory_cache_size": 89
}
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –µ—Å–ª–∏ >5 —Å–µ–∫—É–Ω–¥
- **–û—à–∏–±–∫–∏ API**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è retry –ª–æ–≥–∏–∫–∞
- **Rate limiting**: 15 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Cleanup**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üõ†Ô∏è –°–æ–∑–¥–∞–Ω–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ú–æ–¥—É–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```
data/
‚îú‚îÄ‚îÄ cache.py                    # –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à
‚îú‚îÄ‚îÄ optimized_moex_client.py    # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç
‚îî‚îÄ‚îÄ connection_pool.py          # –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–≤ guide)

bot/utils/
‚îú‚îÄ‚îÄ decorators.py              # Rate limiting, error handling
‚îî‚îÄ‚îÄ performance.py             # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–≤ guide)

bot/handlers/
‚îî‚îÄ‚îÄ optimized_commands.py      # –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã
```

### –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
- `/scan_fast` - –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (12 —Ç–æ–ø-–∞–∫—Ü–∏–π)
- `/cache_stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- `/warm_cache` - –ü—Ä–æ–≥—Ä–µ–≤ –∫—ç—à–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∞–∫—Ü–∏–π
- `/clear_cache` - –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
- `/volume_scan` - –ü–æ–∏—Å–∫ –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–º–æ–≤

## üöÄ –ì–æ—Ç–æ–≤—ã–µ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ñ–∞–π–ª—ã

### ‚úÖ –°–æ–∑–¥–∞–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:
1. **`data/cache.py`** - –°–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
2. **`data/optimized_moex_client.py`** - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç
3. **`bot/utils/decorators.py`** - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
4. **`bot/handlers/optimized_commands.py`** - –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã

### üìã –ì–æ—Ç–æ–≤—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
1. –ó–∞–º–µ–Ω–∏—Ç–µ –∏–º–ø–æ—Ä—Ç—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤ main.py
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–µ–≤ –∫—ç—à–∞

## üîÑ –ü—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –®–∞–≥ 1: –ó–∞–º–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
```python
# –ë—ã–ª–æ:
from data.moex_client import moex_client

# –°—Ç–∞–ª–æ:
from data.optimized_moex_client import optimized_moex_client
```

### –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤
```python
# –ë—ã–ª–æ:
async def some_command(update, context):

# –°—Ç–∞–ª–æ:
@telegram_handler
async def some_command(update, context):
```

### –®–∞–≥ 3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
```python
app.add_handler(CommandHandler("scan_fast", scan_fast))
app.add_handler(CommandHandler("cache_stats", cache_stats))
app.add_handler(CommandHandler("rsi_top", rsi_top_optimized))
```

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- **Redis –∫–ª–∞—Å—Ç–µ—Ä** –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫—ç—à–∞
- **PostgreSQL** –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- **Prometheus + Grafana** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **Docker** –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏
- **Load balancer** –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **Pytest** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤
- **Black + isort** –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
- **Mypy** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–æ–≤
- **Pre-commit hooks** –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

## üéâ –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–°–∫–æ—Ä–æ—Å—Ç—å**: 5-20x –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∫–æ–º–∞–Ω–¥
- **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API**: –°–Ω–∏–∂–µ–Ω–∞ –Ω–∞ 70-90%
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **Rate limiting**: –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- **Error handling**: Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **Monitoring**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ì–æ—Ç–æ–≤–æ –∫ –±–æ–ª—å—à–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- **Connection pooling**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

**–í–∞—à –±–æ—Ç —Ç–µ–ø–µ—Ä—å –≥–æ—Ç–æ–≤ –∫ production –∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ!** üöÄ

---

### üìû –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
/cache_stats

# –ë—ã—Å—Ç—Ä–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–µ–º–æ —Å–∫–æ—Ä–æ—Å—Ç–∏)
/scan_fast

# –ü—Ä–æ–≥—Ä–µ–≤ –∫—ç—à–∞
/warm_cache

# –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
/rsi_top
```

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–∞—é—Ç **–∏–∑–º–µ—Ä–∏–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ 5-20 —Ä–∞–∑** –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –æ–ø–µ—Ä–∞—Ü–∏–π! üìà